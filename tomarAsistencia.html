<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="icon" type="image/png" href="./img/favicon2.jpg">
    <title>Presente</title>
    <link href="style.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        h1 {
            text-align: center;
            margin-top: 20px;
            color: #fff;
        }
    </style>
</head>

<body>
    <header class="app-header">
        <button class="back-btn" onclick="volverAClases()">&larr;</button>
        <h1 id="tituloClase">MatemÃ¡ticas - 1Â°A</h1>
    </header>
    <div class="app-container">
        <p class="date" id="fechaActual"></p>

        <div id="listaAlumnosContainer">
        </div>

        <div class="botonera">
            <button onclick="cerrarRegistro()">CERRAR<br>REGISTRO</button>
            <button onclick="marcarTodos('P')">TODOS<br>PRESENTES</button>
        </div>
    </div>

    <script>
        // FunciÃ³n para obtener parÃ¡metro de la URL
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // FunciÃ³n para formatear fecha
        function formatearFecha(fecha) {
            const opciones = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return fecha.toLocaleDateString('es-ES', opciones);
        }

        // FunciÃ³n para generar las tarjetas de alumnos
        function generarTarjetasAlumnos(alumnos) {
            const container = document.getElementById('listaAlumnosContainer');
            container.innerHTML = '';

            alumnos.forEach((alumno, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
            <div class="photo">ðŸ‘¤</div>
            <div class="info">
                <div class="name">${alumno}</div>
                <div class="radios">
                    <div class="radio-group">
                        <label for="alumno${index}_p">P</label>
                        <input type="radio" id="alumno${index}_p" name="asistencia${index}" value="P">
                    </div>
                    <div class="radio-group">
                        <label for="alumno${index}_a">A</label>
                        <input type="radio" id="alumno${index}_a" name="asistencia${index}" value="A">
                    </div>
                    <div class="radio-group">
                        <label for="alumno${index}_t">T</label>
                        <input type="radio" id="alumno${index}_t" name="asistencia${index}" value="T">
                    </div>
                </div>
            </div>
        `;
                container.appendChild(card);
            });
        }

        // FunciÃ³n principal al cargar la pÃ¡gina
        document.addEventListener('DOMContentLoaded', () => {
            const claseId = getQueryParam('claseId');
            if (!claseId) {
                // MODIFICACIÃ“N: Usar SweetAlert para alertas
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Clase no especificada. Redirigiendo a clases.',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'clases.html';
                });
                return;
            }

            // Obtener la clase del localStorage
            const clases = JSON.parse(localStorage.getItem('clases')) || [];
            const clase = clases.find(c => c.id == claseId);
            if (!clase) {
                // MODIFICACIÃ“N: Usar SweetAlert para alertas
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Clase no encontrada. Redirigiendo a clases.',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'clases.html';
                });
                return;
            }

            // Mostrar datos de la clase
            document.getElementById('tituloClase').textContent = `${clase.nombre} - ${clase.curso}`;

            // Mostrar fecha actual
            const fechaActual = new Date();
            document.getElementById('fechaActual').textContent = formatearFecha(fechaActual);

            // Generar tarjetas de alumnos
            generarTarjetasAlumnos(clase.alumnos);
        });

        // âœ… Marca todos los radios con un valor dado (P, A o T)
        function marcarTodos(valor) {
            const radios = document.querySelectorAll(`input[type="radio"][value="${valor}"]`);
            radios.forEach(radio => radio.checked = true);
        }

        // âœ… Cierra el registro y guarda la asistencia
        function cerrarRegistro() {
            const radios = document.querySelectorAll('input[type="radio"]');
            const grupos = {};

            // Agrupar por name (cada grupo representa un alumno)
            radios.forEach(radio => {
                const name = radio.name;
                if (!grupos[name]) grupos[name] = [];
                grupos[name].push(radio);
            });

            // Para cada grupo (alumno), si no estÃ¡ marcado ni P ni T, marcar A
            Object.values(grupos).forEach(grupo => {
                const algunoMarcado = grupo.find(r => r.checked && (r.value === "P" || r.value === "T"));
                if (!algunoMarcado) {
                    const ausente = grupo.find(r => r.value === "A");
                    if (ausente) ausente.checked = true;
                }
            });

            // Guardar el registro y luego mostrar SweetAlert
            guardarAsistencia();
            // La redirecciÃ³n se harÃ¡ dentro de guardarAsistencia() ahora
        }

        // Volver a la pÃ¡gina de clases (ya no se llama directamente desde cerrarRegistro)
        function volverAClases() {
            window.location.href = 'clases.html';
        }

        // Guardar la asistencia en localStorage
        function guardarAsistencia() {
            const claseId = getQueryParam('claseId');
            if (!claseId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo guardar la asistencia: ID de clase no encontrado.',
                    confirmButtonText: 'Entendido'
                }).then(() => {
                    volverAClases();
                });
                return;
            }

            const fecha = new Date().toISOString().split('T')[0]; // Formato YYYY-MM-DD
            const registros = [];

            // Recorrer todas las tarjetas de alumnos
            document.querySelectorAll('.card').forEach((card, index) => {
                const nombre = card.querySelector('.name').textContent;
                // Obtener el estado seleccionado (P, A o T)
                const estado = card.querySelector(`input[name="asistencia${index}"]:checked`)?.value || 'A';

                // Convertir P, A, T a Presente, Ausente, Tardanza para legibilidad en registros
                let estadoCompleto;
                switch (estado) {
                    case 'P':
                        estadoCompleto = 'Presente';
                        break;
                    case 'A':
                        estadoCompleto = 'Ausente';
                        break;
                    case 'T':
                        estadoCompleto = 'Tardanza';
                        break;
                    default:
                        estadoCompleto = 'Desconocido'; // Por si acaso
                }

                registros.push({ nombre, estado: estadoCompleto });
            });

            // Guardar en localStorage con clave Ãºnica
            const clave = `asistencia_${claseId}_${fecha.replace(/-/g, '_')}`; // Asegura YYYY_MM_DD
            localStorage.setItem(clave, JSON.stringify(registros));

            // MODIFICACIÃ“N: Mostrar mensaje de Ã©xito con SweetAlert2
            Swal.fire({
                title: 'Registro Cerrado',
                text: `Asistencia del ${formatearFecha(new Date())} guardada correctamente.`,
                icon: 'success',
                timer: 2000, // La alerta se cierra automÃ¡ticamente despuÃ©s de 2 segundos
                showConfirmButton: false, // Oculta el botÃ³n de "OK"
                allowOutsideClick: false // No permite cerrar haciendo clic afuera
            }).then(() => {
                // Esta parte se ejecuta DESPUÃ‰S de que la alerta se cierra
                volverAClases();
            });
        }
    </script>
</body>

</html>