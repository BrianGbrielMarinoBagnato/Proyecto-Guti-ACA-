<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="./img/favicon.png" />
    <title>Presente</title>
    <link rel="stylesheet" href="style.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        #btnAgregarAlumno {
            background-color: gray;
            color: white;
            border: none;
            padding: 6px 12px;
            font-size: 18px;
            cursor: not-allowed;
            transition: background-color 0.3s ease;
        }

        #btnAgregarAlumno.activo {
            background-color: royalblue;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .modal-contenido {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cerrar-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .botones-finales {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* NUEVA ADICIÓN: Estilos para el input de archivo (oculto) */
        #inputArchivoImportar {
            display: none;
        }

        /* FIN NUEVA ADICIÓN */
    </style>
</head>

<body>
    <div class="header">
        <a href="index.html" class="back-arrow">&larr;</a>
        Crear Nueva Clase
    </div>

    <div class="container">
        <label for="nombre">Nombre de Clase</label>
        <input type="text" id="nombre" placeholder="Matemáticas 101" required />

        <label for="curso">Curso</label>
        <input type="text" id="curso" placeholder="1er Año" required />

        <label for="alumno">Nuevo Alumno</label>
        <div class="alumno-input">
            <input type="text" id="alumno" placeholder="Nombre completo" />
            <button id="btnAgregarAlumno">+</button>
        </div>

        <h4 class="subtitulo">Alumnos añadidos</h4>
        <div class="lista-alumnos"></div>

        <div class="botones-finales">
            <button id="btnGuardar">GUARDAR</button>
            <button id="btnImportar">IMPORTAR</button>
            <input type="file" id="inputArchivoImportar"
                accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
        </div>
    </div>

    <div id="modalSalirSinGuardar" class="modal">
        <div class="modal-contenido">
            <div class="modal-header">
                <h3>¿Salir sin guardar?</h3>
                <button class="cerrar-modal" id="cerrarModalSalir">&times;</button>
            </div>
            <p>Tienes cambios sin guardar. ¿Deseas salir de todos modos?</p>
            <div class="botones-finales">
                <button id="confirmarSalida">Sí, salir</button>
                <button id="cancelarSalida">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        let alumnosTemp = [];
        let isDirty = false;
        let claseActual = {
            nombre: '',
            curso: '',
            alumnos: []
        };

        const listaAlumnos = document.querySelector('.lista-alumnos');
        const btnAgregarAlumno = document.getElementById('btnAgregarAlumno');
        const inputAlumno = document.getElementById('alumno');
        function actualizarEstiloBotonAgregar() {
            const tieneTexto = inputAlumno.value.trim().length > 0;
            if (tieneTexto) {
                btnAgregarAlumno.classList.add('activo');
            } else {
                btnAgregarAlumno.classList.remove('activo');
            }
        }
        inputAlumno.addEventListener('input', actualizarEstiloBotonAgregar);

        const btnGuardar = document.getElementById('btnGuardar');
        const inputNombreClase = document.getElementById('nombre');
        const inputCurso = document.getElementById('curso');
        const linkVolver = document.querySelector('.back-arrow');

        const modalSalir = document.getElementById('modalSalirSinGuardar');
        const btnCerrarModalSalir = document.getElementById('cerrarModalSalir');
        const btnConfirmarSalida = document.getElementById('confirmarSalida');
        const btnCancelarSalida = document.getElementById('cancelarSalida');

        // NUEVA ADICIÓN: Elementos para la importación
        const btnImportar = document.getElementById('btnImportar');
        const inputArchivoImportar = document.getElementById('inputArchivoImportar');
        // FIN NUEVA ADICIÓN

        // Detectar edición desde URL
        function obtenerParametro(nombre) {
            const url = new URL(window.location.href);
            return url.searchParams.get(nombre);
        }

        const idEditar = obtenerParametro('editar');
        if (idEditar) {
            const clasesGuardadas = JSON.parse(localStorage.getItem('clases')) || [];
            const claseEditada = clasesGuardadas.find(c => c.id == idEditar);

            if (claseEditada) {
                inputNombreClase.value = claseEditada.nombre;
                inputCurso.value = claseEditada.curso;
                alumnosTemp = [...claseEditada.alumnos];
                actualizarListaUI();
                claseActual.id = claseEditada.id;
                isDirty = false;
            }
        }

        function crearAlumnoUI(nombre, index) {
            const div = document.createElement('div');
            div.className = 'alumno-item';

            const spanNombre = document.createElement('span');
            spanNombre.textContent = nombre;
            spanNombre.className = 'nombre-alumno';
            // MODIFICACIÓN: Asegurarse de que el índice se actualice correctamente en la UI
            spanNombre.dataset.index = index;

            const acciones = document.createElement('div');
            acciones.className = 'acciones';


            const btnEditar = document.createElement('button');
            btnEditar.title = "Editar alumno";
            const iconoEditar = document.createElement('img');
            iconoEditar.src = 'img/favicon.png';
            iconoEditar.alt = 'Editar';
            iconoEditar.style.width = '20px';
            iconoEditar.style.height = '20px';
            btnEditar.appendChild(iconoEditar);
            // MODIFICACIÓN: Pasar el span y el índice al editarAlumno
            btnEditar.onclick = () => editarAlumno(spanNombre, index);

            const btnEliminar = document.createElement('button');
            btnEliminar.title = "Eliminar alumno";
            const iconoEliminar = document.createElement('img');
            iconoEliminar.src = 'Vector.png';
            iconoEliminar.alt = 'Eliminar';
            iconoEliminar.style.width = '20px';
            iconoEliminar.style.height = '20px';
            btnEliminar.appendChild(iconoEliminar);

            btnEliminar.onclick = () => {
                alumnosTemp.splice(index, 1);
                actualizarListaUI();
                isDirty = true;
            };

            acciones.appendChild(btnEditar);
            acciones.appendChild(btnEliminar);
            div.appendChild(spanNombre);
            div.appendChild(acciones);
            listaAlumnos.appendChild(div);
        }

        function actualizarListaUI() {
            listaAlumnos.innerHTML = '';
            alumnosTemp.forEach((nombre, index) => crearAlumnoUI(nombre, index));
        }

        // MODIFICACIÓN: editarAlumno ahora recibe el índice
        function editarAlumno(span, originalIndex) {
            const originalNombre = span.textContent;
            const contenedor = span.parentElement;

            const input = document.createElement('input');
            input.value = originalNombre;
            input.className = 'input-edicion';
            input.type = 'text';

            const acciones = contenedor.querySelector('.acciones');
            acciones.innerHTML = '';

            const btnAceptar = document.createElement('button');
            btnAceptar.title = "Aceptar";
            const iconoCheck = document.createElement('img');
            iconoCheck.src = 'img/check.png';
            iconoCheck.alt = 'Aceptar';
            iconoCheck.style.width = '20px';
            iconoCheck.style.height = '20px';
            btnAceptar.appendChild(iconoCheck);
            btnAceptar.onclick = () => {
                const nuevoNombre = input.value.trim();
                if (nuevoNombre !== '') {
                    alumnosTemp[originalIndex] = nuevoNombre; // Usa originalIndex
                    isDirty = true;
                }
                restaurarVista(span, input, acciones, originalIndex); // Pasa originalIndex
            };

            const btnCancelar = document.createElement('button');
            btnCancelar.title = "Cancelar";
            const iconoCancelar = document.createElement('img');
            iconoCancelar.src = 'img/cancelar.png';
            iconoCancelar.alt = 'Cancelar';
            iconoCancelar.style.width = '20px';
            iconoCancelar.style.height = '20px';
            btnCancelar.appendChild(iconoCancelar);
            btnCancelar.onclick = () => restaurarVista(span, input, acciones, originalIndex); // Pasa originalIndex

            contenedor.insertBefore(input, span);
            span.style.display = 'none';
            input.focus();

            acciones.appendChild(btnAceptar);
            acciones.appendChild(btnCancelar);
        }

        // MODIFICACIÓN: restaurarVista ahora recibe el índice (aunque no lo use directamente)
        function restaurarVista(span, input, acciones, index) {
            input.remove();
            span.style.display = '';
            actualizarListaUI();
        }

        btnAgregarAlumno.addEventListener('click', () => {
            let nombre = inputAlumno.value.trim();
            if (nombre != '') {
                alumnosTemp.push(nombre);
                actualizarListaUI();
                inputAlumno.value = '';
                isDirty = true;
                actualizarEstiloBotonAgregar();
            }
        });

        btnGuardar.addEventListener('click', () => {
            const nombreClase = inputNombreClase.value.trim();
            const curso = inputCurso.value.trim();
            const alumnoPendiente = inputAlumno.value.trim();

            if (!nombreClase || !curso) {
                Swal.fire({
                    icon: 'warning',
                    title: '¡Atención!',
                    text: 'El nombre de la clase y el curso son obligatorios.'
                });
                return;
            }

            if (alumnoPendiente !== '') {
                alumnosTemp.push(alumnoPendiente);
                inputAlumno.value = '';
            }

            claseActual.nombre = nombreClase;
            claseActual.curso = curso;
            claseActual.alumnos = [...alumnosTemp];
            if (!claseActual.id) claseActual.id = Date.now().toString();

            const clasesGuardadas = JSON.parse(localStorage.getItem('clases')) || [];
            const index = clasesGuardadas.findIndex(c => c.id === claseActual.id);
            if (index !== -1) {
                clasesGuardadas[index] = claseActual;
            } else {
                clasesGuardadas.push(claseActual);
            }

            localStorage.setItem('clases', JSON.stringify(clasesGuardadas));
            isDirty = false;

            Swal.fire({
                title: '¡Clase Guardada!',
                text: 'La clase ha sido guardada correctamente.',
                icon: 'success',
                timer: 2000,
                showConfirmButton: false,
                allowOutsideClick: false
            }).then(() => {
                window.location.href = 'index.html';
            });
        });

        // Confirmación al salir
        inputNombreClase.addEventListener('input', () => isDirty = true);
        inputCurso.addEventListener('input', () => isDirty = true);

        linkVolver.addEventListener('click', (e) => {
            const alumnoPendiente = inputAlumno.value.trim();
            if (alumnoPendiente !== '') {
                isDirty = true;
            }
            if (isDirty) {
                e.preventDefault();
                modalSalir.style.display = 'flex';
            }
        });

        btnCerrarModalSalir.addEventListener('click', () => {
            modalSalir.style.display = 'none';
        });

        btnCancelarSalida.addEventListener('click', () => {
            modalSalir.style.display = 'none';
        });

        btnConfirmarSalida.addEventListener('click', () => {
            window.location.href = 'index.html';
        });


        // NUEVA ADICIÓN: Lógica para el botón de importar
        btnImportar.addEventListener('click', () => {
            inputArchivoImportar.click(); // Simula un clic en el input de archivo oculto
        });

        inputArchivoImportar.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();

                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Asumimos que la primera hoja es la que contiene los alumnos
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];

                    // Convertimos la hoja a un array de arrays (filas y columnas)
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (json.length === 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error de Importación',
                            text: 'El archivo Excel/CSV está vacío o no tiene el formato esperado.'
                        });
                        return;
                    }

                    let alumnosImportados = [];
                    // Asumimos que los nombres de los alumnos están en la primera columna (índice 0)
                    // Saltamos la primera fila si es un encabezado (ej. "Nombre de Alumno")
                    for (let i = 0; i < json.length; i++) {
                        const row = json[i];
                        if (row[0] && typeof row[0] === 'string' && row[0].trim() !== '') {
                            alumnosImportados.push(row[0].trim());
                        }
                    }

                    if (alumnosImportados.length > 0) {
                        alumnosTemp = [...new Set([...alumnosTemp, ...alumnosImportados])]; // Agrega y elimina duplicados
                        actualizarListaUI();
                        isDirty = true;
                        Swal.fire({
                            icon: 'success',
                            title: '¡Importación Exitosa!',
                            text: `${alumnosImportados.length} alumnos importados.`,
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: '¡Importación Parcial!',
                            text: 'No se encontraron nombres de alumnos válidos en la primera columna del archivo.',
                        });
                    }
                };

                reader.onerror = (error) => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error al leer el archivo',
                        text: 'Hubo un problema al cargar el archivo. Inténtalo de nuevo.'
                    });
                    console.error('Error al leer el archivo:', error);
                };

                reader.readAsArrayBuffer(file); // Lee el archivo como un ArrayBuffer para SheetJS
            }
        });
        // FIN NUEVA ADICIÓN
    </script>
</body>

</html>