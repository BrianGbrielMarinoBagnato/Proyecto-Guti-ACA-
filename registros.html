<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <title>Registros de Asistencia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
        .app-header {
            display: flex;
            /* Mi estilo: Usa flexbox para alinear el botón y el título */
            align-items: center;
            /* Mi estilo: Centra verticalmente los elementos */
            padding: 10px;
            /* Mi estilo: Añade un poco de padding al header */
            position: relative;
            /* Mi estilo: Si el back-btn es absoluto, su padre debe ser relativo */
        }
    </style>
</head>

<body class="fondo-registros">
    <div class="app-header">
        <button class="back-btn" onclick="volverAClases()">&larr;</button>
        <!-- Mi estilo: Botón de retroceso -->
        <h2>Registros de Asistencia</h2>
    </div>

    <div class="busqueda-fecha">
        <label for="fecha">Filtrar por fecha</label>
        <input type="date" id="fecha" />
    </div>

    <h3 id="clases-recientes">Clases Recientes</h3>

    <div class="registros-container">
    </div>

    <div id="modal" class="modal">
        <div class="modal-contenido">
            <h3 id="modal-titulo">Detalles de Asistencia</h3>
            <ul id="lista-detalles"></ul>
            <button onclick="cerrarModal()">Cerrar</button>
        </div>
    </div>

    <script>
        // Datos de ejemplo para demostración
        const demoData = {
            clases: [
                { id: "1", nombre: "Matemáticas Avanzadas", curso: "10mo A" },
                { id: "2", nombre: "Literatura Contemporánea", curso: "11vo B" },
                { id: "3", nombre: "Física Cuántica", curso: "12vo C" }
            ],
            asistencias: {
                "asistencia_1_2024_05_20": [
                    { nombre: "María García", estado: "Presente" },
                    { nombre: "Carlos López", estado: "Presente" },
                    { nombre: "Ana Martínez", estado: "Ausente" },
                    { nombre: "Pedro Sánchez", estado: "Tardanza" }
                ],
                "asistencia_2_2024_05_22": [
                    { nombre: "Lucía Fernández", estado: "Presente" },
                    { nombre: "Jorge Ruiz", estado: "Ausente" },
                    { nombre: "Sofía Díaz", estado: "Presente" }
                ],
                "asistencia_3_2024_05_25": [
                    { nombre: "Miguel Ángel Torres", estado: "Presente" },
                    { nombre: "Elena Vargas", estado: "Presente" },
                    { nombre: "David Jiménez", estado: "Presente" },
                    { nombre: "Laura Gómez", estado: "Tardanza" }
                ]
            }
        };

        // Cargar datos de demostración
        function cargarDatosDemo() {
            // Solo cargamos los datos de demostración si la clave 'clases' no existe
            // para evitar sobrescribir las clases del usuario.
            if (!localStorage.getItem('clases')) {
                localStorage.setItem('clases', JSON.stringify(demoData.clases));
                for (const [key, value] of Object.entries(demoData.asistencias)) {
                    // Asegurarse de no sobrescribir asistencias existentes si se quiere mantener una mezcla,
                    // aunque en este caso, se asume que si no hay 'clases', tampoco hay asistencias.
                    if (!localStorage.getItem(key)) {
                        localStorage.setItem(key, JSON.stringify(value));
                    }
                }
            }
        }

        // Función para formatear fechas
        function formatearFecha(fechaStr) {
            if (!fechaStr) return "";
            // Manejar formato con guiones bajos
            const partes = fechaStr.includes("_") ? fechaStr.split("_") : fechaStr.split("-");
            if (partes.length >= 3) {
                const [y, m, d] = partes;
                return `${d.padStart(2, '0')}/${m.padStart(2, '0')}/${y}`;
            }
            return fechaStr;
        }

        // Obtener parámetro de URL
        function obtenerParametro(nombre) {
            const params = new URLSearchParams(window.location.search);
            return params.get(nombre);
        }

        // Cargar registros desde localStorage
        function cargarRegistros() {
            const clases = JSON.parse(localStorage.getItem('clases')) || [];
            const claseIdSeleccionada = obtenerParametro('claseId');
            const contenedor = document.querySelector('.registros-container');
            contenedor.innerHTML = '';

            let registrosEncontrados = false;
            let todasLasAsistencias = [];

            // Recorrer localStorage para encontrar todas las asistencias
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('asistencia_')) {
                    todasLasAsistencias.push(key);
                }
            }

            // Ordenar las asistencias por fecha (las más recientes primero)
            todasLasAsistencias.sort((a, b) => {
                const fechaA = a.split('_').slice(2).join(''); // Ej: "2024_05_20" -> "20240520"
                const fechaB = b.split('_').slice(2).join('');
                return fechaB.localeCompare(fechaA); // Para ordenar de más reciente a más antigua
            });


            todasLasAsistencias.forEach(key => {
                const partes = key.split('_');
                const claseId = partes[1];
                const fecha = partes.slice(2).join('_');

                if (claseIdSeleccionada && claseId !== claseIdSeleccionada) return; // Si hay filtro por claseId, ignorar

                const clase = clases.find(c => c.id == claseId);
                if (clase) {
                    registrosEncontrados = true;
                    const tarjeta = document.createElement('div');
                    tarjeta.className = 'tarjeta-registro';
                    tarjeta.innerHTML = `
                        <p>Clase: <strong>${clase.nombre}</strong><br>Curso: ${clase.curso}</p>
                        <span>${formatearFecha(fecha)}</span>
                    `;
                    tarjeta.addEventListener('click', () => mostrarDetalles(key));
                    contenedor.appendChild(tarjeta);
                }
            });


            if (!registrosEncontrados) {
                contenedor.innerHTML = `
                <div class="empty-state">
                    <h4>No hay registros de asistencia</h4>
                    <p>Cuando tomes asistencia, aparecerán aquí</p>
                </div>
            `;
            }
        }

        // Mostrar detalles en el modal
        function mostrarDetalles(clave) {
            const datos = JSON.parse(localStorage.getItem(clave));
            const lista = document.getElementById('lista-detalles');
            lista.innerHTML = '';

            // Extraer fecha de la clave
            const partes = clave.split('_');
            const fechaRaw = partes.slice(2).join('_');
            const titulo = document.getElementById('modal-titulo');
            titulo.textContent = `Asistencia del ${formatearFecha(fechaRaw)}`;

            datos.forEach(a => {
                const li = document.createElement('li');

                // Determinar color según estado
                let estadoClass = '';
                if (a.estado === 'Presente') estadoClass = 'presente';
                if (a.estado === 'Ausente') estadoClass = 'ausente';
                if (a.estado === 'Tardanza') estadoClass = 'tardanza';

                li.innerHTML = `
                <span>${a.nombre}</span>
                <span class="estado ${estadoClass}">${a.estado}</span>
            `;
                lista.appendChild(li);
            });

            const modal = document.getElementById('modal');
            modal.classList.add('visible');
        }

        // Cerrar modal
        function cerrarModal() {
            const modal = document.getElementById('modal');
            modal.classList.remove('visible');
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar datos de demostración si la clave 'clases' no existe
            // Esto asegura que los datos de demostración solo se carguen una vez
            // al iniciar la aplicación si no hay datos de usuario.
            if (!localStorage.getItem('clases')) {
                cargarDatosDemo();
            }

            cargarRegistros();

            // Event listener para cerrar modal haciendo clic fuera del contenido
            const modal = document.getElementById('modal');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    cerrarModal();
                }
            });

            // Filtrar por fecha
            const inputFecha = document.getElementById('fecha');
            inputFecha.addEventListener('change', () => {
                const fechaFiltro = inputFecha.value.replace(/-/g, '_'); // Convertir YYYY-MM-DD a YYYY_MM_DD
                filtrarRegistrosPorFecha(fechaFiltro);
            });
        });

        // NUEVA FUNCIÓN: Filtrar registros por fecha
        function filtrarRegistrosPorFecha(fecha) {
            const clases = JSON.parse(localStorage.getItem('clases')) || [];
            const contenedor = document.querySelector('.registros-container');
            contenedor.innerHTML = '';

            let registrosEncontrados = false;
            let asistenciasFiltradas = [];

            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('asistencia_')) {
                    const partes = key.split('_');
                    const fechaRegistro = partes.slice(2).join('_'); // YYYY_MM_DD
                    if (fecha === "" || fechaRegistro === fecha) { // Si fecha es vacía, mostrar todo; si no, filtrar
                        asistenciasFiltradas.push(key);
                    }
                }
            }

            // Ordenar las asistencias filtradas por fecha (las más recientes primero)
            asistenciasFiltradas.sort((a, b) => {
                const fechaA = a.split('_').slice(2).join('');
                const fechaB = b.split('_').slice(2).join('');
                return fechaB.localeCompare(fechaA);
            });

            asistenciasFiltradas.forEach(key => {
                const partes = key.split('_');
                const claseId = partes[1];
                const fechaAsistencia = partes.slice(2).join('_');

                const clase = clases.find(c => c.id == claseId);
                if (clase) {
                    registrosEncontrados = true;
                    const tarjeta = document.createElement('div');
                    tarjeta.className = 'tarjeta-registro';
                    tarjeta.innerHTML = `
                        <p>Clase: <strong>${clase.nombre}</strong><br>Curso: ${clase.curso}</p>
                        <span>${formatearFecha(fechaAsistencia)}</span>
                    `;
                    tarjeta.addEventListener('click', () => mostrarDetalles(key));
                    contenedor.appendChild(tarjeta);
                }
            });

            if (!registrosEncontrados) {
                contenedor.innerHTML = `
                    <div class="empty-state">
                        <h4>No hay registros de asistencia para la fecha seleccionada.</h4>
                        <p>Intenta con otra fecha o borra el filtro.</p>
                    </div>
                `;
            }
        }
        // Si necesitas la función volverAClases, defínela correctamente:
        function volverAClases() {
            window.location.href = "clases.html";
        }
    </script>
</body>

</html>